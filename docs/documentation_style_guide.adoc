= Documentation Style Guide & Lessons Learned
:toc: macro
:toc-title: Table of Contents
:icons: font
:source-highlighter: highlight.js

toc::[]

This document serves as the **authoritative reference** for creating and maintaining documentation in the Brick Engine project. It consolidates lessons learned during development and defines the standards for future contributions.

== Architectural Patterns

These patterns must be reflected in both the code and the documentation.

=== 1. Centralized Persistence
*   **Principle**: `GameState` is the **single source of truth** for all persistent data (e.g., `muted`, `highScore`, `colorEnabled`).
*   **Rule**: Other modules (e.g., `GameSound`, `GameRenderer`) must **NOT** implement their own `localStorage` logic.
*   **Pattern**:
    .   **Interface**: Modules requiring state must implement `StateSyncable`.
    .   **Initialization**: `Game.ts` iterates over modules and calls `syncState(state)` on those that implement the interface.
    .   **Decoupling**: `GameState` must **NOT** have dependencies on other game modules.
    .   **Updates**: Modules subscribe to `GameState` changes via `state.subscribe()`.

=== 2. Event-Driven State
*   **Principle**: Reactivity over polling.
*   **Mechanism**:
    *   State properties are encapsulated with **getters/setters**.
    *   Setters automatically trigger `_notify(property, value)`.
    *   Subscribers receive the new value immediately.

=== 3. Strict Module Interfaces
*   **Principle**: Coupling through interfaces, not implementation.
*   **Guideline**: Define module shapes in `src/core/types/modules.ts` (e.g., `Sound`, `Grid`, `Time`).

== API Documentation Standards

All `.adoc` files in `docs/reference/` must follow this strict structure for methods.

=== Method Structure

All methods should be listed directly under the `== API Reference` section using `===` headers. **Do not group methods into sub-categories** (e.g., "Configuration", "Render") as this breaks the standard flat structure.

[source,asciidoc]
----
=== `methodName(param1: Type, param2: Type): ReturnType`

<Brief description of what the method does.>

**Parameters**

[cols="1,1,3"]
|===
|Name |Type |Description
|`param1` |`Type` |Description of parameter 1.
|`param2` |`Type` |Description of parameter 2.
|===

**Returns**

`ReturnType` - Description of the return value.

**Behavior**

<Paragraph describing side effects, logic details, or important notes.>

**Example**

[source,typescript]
\----
instance.methodName('arg1', 123);
\----
----

=== Style Rules
.   **Hierarchy**:
    *   Use `===` for all methods.
    *   Maintain a **flat list** of methods under `== API Reference`.
.   **Parameters**:
    *   Use a table for arguments.
    *   **OMIT this section completely** if there are no parameters.
.   **Returns**:
    *   Describe the return value.
    *   **OMIT this section completely** if the return type is `void`.
.   **Behavior**: Use full sentences and paragraphs.
.   **Examples**: Provide realistic usage scenarios.

== Formatting Guidelines

=== AsciiDoc Features
We use **AsciiDoc** (`.adoc`) for all documentation to leverage advanced features.

*   **Headers**: Use `=` for document titles, `==` for sections.
*   **Code Blocks**: Use `[source,typescript]` for syntax highlighting.
*   **Admonitions**: Use `NOTE:`, `TIP:`, `WARNING:` for emphasis.
*   **Diagrams**: Use Mermaid via `mermaid-cli` for generation (embedded as generic images).

=== JSDoc (Source Code)
Refer to `docs/jsdoc_standard.adoc` for inline code documentation rules.
*   **Enforce**: `@param` and `@returns` for every method.
*   **Strict Typing**: No `any`.

== Lessons Learned

=== Audio Latency
*   **Issue**: `AudioContext` autoplay policy and startup latency.
*   **Solution**:
    .   Use `latencyHint: 'interactive'`.
    .   Preload all sounds into `AudioBuffer`s during `setup()`.
    .   Resume context on first user interaction if suspended.

=== Enumerations
*   **Issue**: String literals ('pressed', 'held') caused typos and refactoring pain.
*   **Solution**: Use TypeScript `enum` (e.g., `ControlEventType`) for all fixed sets of values.

=== Coordinate Systems
*   **Standard**:
    *   **Grid**: Integers `{x, y}` representing column/row index.
    *   **Display**: Normalized floats `0.0` to `1.0` (percentage of screen).
    *   Use `CoordinateHelper` methods to convert between Grid, Display, and Pixel values.

=== Decoupled State Sync
*   **Issue**: `GameState.syncModules` creates a circular dependency or high coupling by making the state module know about every other module.
*   **Solution**: Use the `StateSyncable` interface. The `Game` class (owner) handles the linking, allowing `GameState` to remain an independent "data store" module.
